name: Run Login Now

on:
  workflow_dispatch:

jobs:
  run-login:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Show repository structure
      run: |
        echo "=== Repository Structure ==="
        find . -type f | head -30
        echo ""
        echo "=== Python files in root ==="
        ls -la *.py || echo "No Python files in root"
        echo ""
        echo "=== Python files in subdirectories ==="
        find . -name "*.py" -type f
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium
        
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Verify setup
      run: |
        echo "=== Setup Verification ==="
        python --version
        google-chrome --version
        pip list | grep selenium
        
    - name: Environment variable test
      run: |
        echo "=== Environment Test ==="
        echo "NETLIB_ACCOUNTS exists: ${NETLIB_ACCOUNTS:+Yes}${NETLIB_ACCOUNTS:-No}"
        echo "NETLIB_ACCOUNTS length: ${#NETLIB_ACCOUNTS}"
        echo ""
        echo "Python check:"
        python -c "import os; print('NETLIB_ACCOUNTS in os.environ:', 'NETLIB_ACCOUNTS' in os.environ)"
        python -c "import os; print('NETLIB_ACCOUNTS length:', len(os.environ.get('NETLIB_ACCOUNTS', '')))"
        python -c "import os; print('NETLIB_ACCOUNTS preview:', os.environ.get('NETLIB_ACCOUNTS', '')[:30])"
        
      env:
        NETLIB_ACCOUNTS: ${{ secrets.NETLIB_ACCOUNTS }}
    
    - name: Run login script
      run: |
        echo "=== Running Login Script ==="
        # 检查脚本文件
        if [ -f "./run_login.py" ]; then
          echo "Found run_login.py in current directory"
          python run_login.py
        elif [ -f "./netlib-login-script/run_login.py" ]; then
          echo "Found run_login.py in netlib-login-script directory"
          python netlib-login-script/run_login.py
        else
          echo "❌ run_login.py not found!"
          find . -name "*.py"
          exit 1
        fi
        
      env:
        NETLIB_ACCOUNTS: ${{ secrets.NETLIB_ACCOUNTS }}
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: login-results
        path: |
          *.png
          *.log
      if: always()
