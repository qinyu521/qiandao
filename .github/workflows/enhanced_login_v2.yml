name: Enhanced Login Workflow v2

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点运行
  workflow_dispatch:

jobs:
  enhanced-login:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Show repository structure
      run: |
        echo "=== Repository Structure ==="
        find . -type f | head -30
        echo ""
        echo "=== Python files ==="
        find . -name "*.py" -type f
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager
        
    - name: Install Chrome and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable chromium-chromedriver
        # 验证安装
        echo "Chrome version:"
        google-chrome --version || chromium --version
        echo "ChromeDriver version:"
        chromedriver --version
        
    - name: System information
      run: |
        echo "=== System Information ==="
        uname -a
        echo "=== Python Information ==="
        python --version
        pip --version
        echo "=== Memory Information ==="
        free -h
        echo "=== Disk Information ==="
        df -h
        
    - name: Environment variable verification
      run: |
        echo "=== Environment Variables ==="
        echo "NETLIB_ACCOUNTS exists: ${NETLIB_ACCOUNTS:+Yes}${NETLIB_ACCOUNTS:-No}"
        echo "NETLIB_ACCOUNTS length: ${#NETLIB_ACCOUNTS}"
        echo "NETLIB_ACCOUNTS preview: ${NETLIB_ACCOUNTS:0:30}..."
        echo ""
        echo "Python environment check:"
        python -c "import os; print('NETLIB_ACCOUNTS in os.environ:', 'NETLIB_ACCOUNTS' in os.environ)"
        python -c "import os; print('NETLIB_ACCOUNTS length:', len(os.environ.get('NETLIB_ACCOUNTS', '')))"
        python -c "import os; print('NETLIB_ACCOUNTS preview:', os.environ.get('NETLIB_ACCOUNTS', '')[:30])"
        
      env:
        NETLIB_ACCOUNTS: ${{ secrets.NETLIB_ACCOUNTS }}
    
    - name: Run enhanced login script
      run: |
        echo "=== Running Enhanced Login Script v2 ==="
        python enhanced_login_v2.py
      env:
        NETLIB_ACCOUNTS: ${{ secrets.NETLIB_ACCOUNTS }}
        PYTHONUNBUFFERED: 1
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: enhanced-login-results
        path: |
          *.png
          *.log
          *.txt
      if: always()
