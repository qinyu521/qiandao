name: Fixed Browser Login Workflow

on:
  workflow_dispatch:

jobs:
  fixed-browser-login:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Show repository structure
      run: |
        echo "=== Repository Structure ==="
        find . -type f | head -30
        echo ""
        echo "=== Python files ==="
        find . -name "*.py" -type f
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install core dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager
        
    - name: Install Chrome with fallback
      run: |
        echo "=== Installing Chrome ==="
        
        # 首先尝试安装Google Chrome
        if ! sudo apt-get update; then
          echo "⚠️ apt update failed, trying alternative..."
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get update || echo "apt update still failed"
        fi
        
        # 尝试安装Google Chrome
        if sudo apt-get install -y google-chrome-stable; then
          echo "✅ Google Chrome installed successfully"
        else
          echo "⚠️ Google Chrome installation failed, trying Chromium..."
          # 如果Google Chrome安装失败，尝试安装Chromium
          if sudo apt-get install -y chromium-browser; then
            echo "✅ Chromium installed successfully"
          else
            echo "⚠️ Chromium installation also failed, trying snap..."
            # 如果都失败，尝试snap安装
            if sudo snap install chromium; then
              echo "✅ Chromium installed via snap"
            else
              echo "❌ All browser installation attempts failed"
              exit 1
            fi
          fi
        fi
        
        # 验证安装
        echo "=== Verifying browser installation ==="
        if command -v google-chrome &> /dev/null; then
          echo "Google Chrome found:"
          google-chrome --version
          echo "Path: $(which google-chrome)"
        elif command -v chromium-browser &> /dev/null; then
          echo "Chromium found:"
          chromium-browser --version
          echo "Path: $(which chromium-browser)"
        elif command -v chromium &> /dev/null; then
          echo "Chromium (snap) found:"
          chromium --version
          echo "Path: $(which chromium)"
        else
          echo "❌ No browser found after installation"
          exit 1
        fi
        
        # 检查ChromeDriver
        echo "=== Checking ChromeDriver ==="
        if command -v chromedriver &> /dev/null; then
          echo "ChromeDriver found:"
          chromedriver --version
        else
          echo "⚠️ ChromeDriver not found, will use webdriver-manager"
        fi
        
    - name: System and browser information
      run: |
        echo "=== System Information ==="
        uname -a
        echo "=== Python Information ==="
        python --version
        pip --version
        echo "=== Installed packages ==="
        pip list | grep -E "(selenium|webdriver-manager)"
        echo "=== Browser paths ==="
        ls -la /usr/bin/google-chrome* 2>/dev/null || echo "No google-chrome"
        ls -la /usr/bin/chromium* 2>/dev/null || echo "No chromium"
        echo "=== Environment variables ==="
        env | grep -E "(CHROME|CHROMIUM)" | sort
        
    - name: Environment variable verification
      run: |
        echo "=== Environment Variables ==="
        echo "NETLIB_ACCOUNTS exists: ${NETLIB_ACCOUNTS:+Yes}${NETLIB_ACCOUNTS:-No}"
        echo "NETLIB_ACCOUNTS length: ${#NETLIB_ACCOUNTS}"
        echo "NETLIB_ACCOUNTS preview: ${NETLIB_ACCOUNTS:0:30}..."
        echo ""
        echo "Python environment check:"
        python -c "import os; print('NETLIB_ACCOUNTS in os.environ:', 'NETLIB_ACCOUNTS' in os.environ)"
        python -c "import os; print('NETLIB_ACCOUNTS length:', len(os.environ.get('NETLIB_ACCOUNTS', '')))"
        
      env:
        NETLIB_ACCOUNTS: ${{ secrets.NETLIB_ACCOUNTS }}
    
    - name: Run fixed browser login script
      run: |
        echo "=== Running Fixed Browser Login Script ==="
        python fixed_browser_login.py
      env:
        NETLIB_ACCOUNTS: ${{ secrets.NETLIB_ACCOUNTS }}
        PYTHONUNBUFFERED: 1
        # 提供浏览器路径的环境变量
        CHROME_BIN: $(which google-chrome 2>/dev/null || which chromium-browser 2>/dev/null || which chromium 2>/dev/null)
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: fixed-browser-login-results
        path: |
          *.png
          *.log
          *.txt
      if: always()
